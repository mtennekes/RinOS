---
title: "Imputation"
output:
  beamer_presentation:
    includes:
      in_header: ../header.tex
classoption: "aspectratio=169"
---

```{r, echo=FALSE, warning = FALSE, message = FALSE}
library(magrittr)
library(simputation)
data("retailers", package="validate")
ret <- retailers[3:10]
```

## Missing data and imputation

-   Missing data mechanisms
-   Model-based imputation
-   Donor-imputation
-   Imputation with the `simputation` package

## Missing data

### Reasons

- Nonresponse
- Missing data in administrative data sources
- Value is observed but is wrong and therefore erased 
- Joining data sources with mismatches

### Solutions

- Measure/observe again 
- Delete records with missing values
- Take into account when estimating
- Deriving the missing values from the data by using other variables 
- **Impute**

## Missing data mechanisms

The first step with handling missing data is determining the **missing data mechanism**:

- Missing completely at Random (MCAR) 
- Missing at Random (MAR) 
- Not Missing at Random (NMAR) 

## Missing data mechanisms - example

Data on **voting behaviour**:

- Which political party will you vote for?
- Background information from registers: 
  - Sex
  - Income
  - Age

\begin{picture}(0,0)
\put(220,-20){
\includegraphics[height=3cm]{fig/politieke_partijen.PNG}
}
\end{picture}

## Missing data mechanism - example

- X = the observed (complete) variables: sex and age 
- Y = the incomplete variables: political party and income 
- M = the response probability for the political party or income (Y)

\begin{picture}(0,0)
\put(-10,-90){
\includegraphics[height=3cm]{fig/Tabel.PNG}
}
\end{picture}

\begin{picture}(0,0)
\put(280,-80){
\includegraphics[height=4cm]{fig/MCAR.PNG}
}
\end{picture}

## Missing Completely at Random (MCAR)

The probability that data is missing, is the same for all respondents. The reason for the missing data is independent of the data.

Example: All respondents have equal response probabilities to answer about the political party they will vote for.

\begin{picture}(0,0)
\put(280,-80){
\includegraphics[height=4cm]{fig/MCAR.PNG}
}
\end{picture}

## Missing at Random (MAR)

The probability that data is missing, is not dependent on the incomplete variable, but is related to the observed variables.

Example: The response probability that the political party is missing, is higher for respondents with a higher income.

\begin{picture}(0,0)
\put(280,-85){
\includegraphics[height=4cm]{fig/MAR.PNG}
}
\end{picture}

## Not Missing at Random (NMAR)

The probability that data is missing, is related to the incomplete variable. 

Example: Respondents that vote for certain political parties more often have a missing value for the political party.
 
\begin{picture}(0,0)
\put(280,-90){
\includegraphics[height=4cm]{fig/NMAR.PNG}
}
\end{picture}

## What data mechanism does the data have?

In practice it is difficult to determine, but you can use:    

- Theoretical information of the data/model   
- Using the context of the data or historical data    
- Descriptive statistics and relations between variables     
- Missing data pattern     

The assumption with imputation often is MAR

## Imputation methodology

### Model based

Estimate a value based on observed variables.

### Donor-imputation

Copy a value from a record that you did observe.

## The `simputation` package

### Provide

- a _uniform interface_,
- with _consistent behaviour_,
- across _commonly used methodologies_

### To facilitate

- experimentation 
- configuration for production

### An imputation prodedure is specified by

1. The variable to impute
2. An imputation model
3. Predictor variables

## The simputation interface

```
impute_<model>(data
  , <imputed vars> ~ <predictor vars>
  , [options])
```

\begin{picture}(0,0)
\put(170,-20){\includegraphics[]{fig/simpute.pdf}}
\end{picture}


## Chaining methods

```{r}

ret %>% 
  impute_rlm(other.rev ~ turnover) %>%
  impute_rlm(other.rev ~ staff) %>% head(3)
```

## Multiple variables, same predictors

```{r,eval=FALSE}
ret %>% 
  impute_rlm(other.rev + total.rev ~ turnover) 

ret %>% 
  impute_rlm( . - turnover ~ turnover) 
```

## Grouping

```{r, eval=FALSE}
retailers %>% impute_rlm(total.rev ~ turnover | size) 

# or, using dplyr::group_by
retailers %>% 
  group_by(size) %>%
  impute_rlm(total.rev ~ turnover)
```

## Imputation and univariate distribution

```{r,echo=FALSE,fig.height=5.5}
set.seed(1)
x <- rnorm(1000)
y <- x
i <- sample(1:1000,100,replace=FALSE)
x[i] <- NA
par(mfrow=c(3,1))
hist(y,main="true data",breaks=50,las=1)
hist(x,main="10% missing values", breaks=50,las=1)
x[i] <- mean(x,na.rm=TRUE)
hist(x,main="Imputating the mean",breaks=50,las=1)
```

## Imputation and bivariate distribution

```{r,echo=FALSE, fig.height=5.5}

par(mfrow=c(1,2))
X <- rnorm(1000)
Y <- X + rnorm(1000,sd = 0.2)
i <- sample(1:1000,100,replace=FALSE)
Y[i] <- NA
plot(X,Y,pch=".",main="10% missing in Y", las=1)
d <- data.frame(X=X,Y=Y)
library(simputation)
d1 <- impute_lm(d,Y ~ X)
cols <- rep("black",1000)
cols[i] <- "red"
cex <- rep(1,1000)
cex[i] <- 4
plot(Y ~ X, data=d1, col=cols,pch=".",cex=cex,las=1,main="Imputation with model Y = a + bX")
```


## Adding a random residual

```{r, echo=FALSE, fig.height=5.5}

par(mfrow=c(1,2))
cols <- rep("black",1000)
cols[i] <- "red"
cex <- rep(1,1000)
cex[i] <- 3
plot(Y ~ X, data=d1, col=cols,pch=".",cex=cex,las=1,main="Imputation with model Y = a + bX")

d2 <- impute_lm(d,Y ~ X,add_residual = "normal")
plot(Y ~ X, data=d2, col=cols,pch=".",cex=cex,las=1,main="Imputation with Y = a + bX + e")
```

## Adding a random residual with `simputation`

### Example

```{r, echo=FALSE, results='hide'}
companies <- read.csv("./data/companies.csv"
                      , stringsAsFactors=FALSE)
```

```{r, results='hide'}
impute_rlm(companies, other.rev ~ turnover
         , add_residual = "normal") 
```

### Options

-  "none"`: (default)
-  "normal"`: from $N(0,\hat{\sigma})$ 
-  "observed"`: from observed residuals

## Chaining methods

### Example

```{r, results='hide'}
companies %>%
  impute_lm(turnover ~ staff + profit) %>%
  impute_lm(turnover ~ staff)
```

## Imputing data with simputation

Other models available in simputation:

|  `<model>  `      |  description                                    |
|-------------------|-------------------------------------------------|
| `proxy`           | copy (transformation of) other variable(s)      |
| `median`          | (group-wise) median                             |
| `rlm`, `lm`, `en` | (robust) linear model, elasticnet regression    |
| `cart`, `rf`      | Classification And Regression Tree, RandomForest|
| `em`, `mf`        | EM-algorithm (multivariate normal) `missForest` |
| `knn`             | $k$ nearest neighbours                          |
| `shd`, `rhd`      | sequential, random, hot-deck                    |
| `pmm`             | predictive mean matching                        |
| `impute_model`    | use pre-trained model                           |
